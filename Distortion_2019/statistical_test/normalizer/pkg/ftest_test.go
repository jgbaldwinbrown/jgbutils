package normalizer

import (
	"fmt"
	"testing"
	"encoding/csv"
	"strings"
)

const ftin = `pos	indiv	hits	althits	count	tissue	chrom	gc	sample	bloodmean	bloodsd	value	sub	norm	indiv_chrom_tissue
16534	15458X11	1	2	3	blood	NC_000001.11	0.43	15458X11	0.5	0	0.3333333333333333	-0.166667	NaN	15458X11_NC_000001.11_blood
182686	15458X11	3	2	5	blood	NC_000001.11	0.43	15458X11	0.3333333333333333	0	0.6	0.266667	NaN	15458X11_NC_000001.11_blood
186810	15458X11	2	2	4	blood	NC_000001.11	0.43	15458X11	0.5333333333333333	0.1333333333333333	0.5	-0.033333	NaN	15458X11_NC_000001.11_blood
186835	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.5416666666666666	0.20833333333333334	0.25	-0.291667	NaN	15458X11_NC_000001.11_blood
261454	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.4777777777777778	0.10999438818457406	0.25	-0.227778	NaN	15458X11_NC_000001.11_blood
261463	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.3	15458X11_NC_000001.11_blood
261478	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X11_NC_000001.11_blood
261495	15458X11	1	4	5	blood	NC_000001.11	0.43	15458X11	0.45208333333333334	0.10514127400787951	0.2	-0.252083	NaN	15458X11_NC_000001.11_blood
261753	15458X11	1	5	6	blood	NC_000001.11	0.43	15458X11	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	NaN	15458X11_NC_000001.11_blood
16534	15458X11	1	2	3	sperm	NC_000001.11	0.43	15458X11	0.5	0	0.3333333333333333	-0.166667	NaN	15458X11_NC_000001.11_sperm
182686	15458X11	3	2	5	sperm	NC_000001.11	0.43	15458X11	0.3333333333333333	0	0.6	0.266667	NaN	15458X11_NC_000001.11_sperm
186810	15458X11	2	2	4	sperm	NC_000001.11	0.43	15458X11	0.5333333333333333	0.1333333333333333	0.5	-0.033333	NaN	15458X11_NC_000001.11_sperm
186835	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.5416666666666666	0.20833333333333334	0.25	-0.291667	NaN	15458X11_NC_000001.11_sperm
261454	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.4777777777777778	0.10999438818457406	0.25	-0.227778	NaN	15458X11_NC_000001.11_sperm
261463	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X11_NC_000001.11_sperm
261478	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X11_NC_000001.11_sperm
261495	15458X11	1	4	5	sperm	NC_000001.11	0.43	15458X11	0.45208333333333334	0.10514127400787951	0.2	-0.252083	NaN	15458X11_NC_000001.11_sperm
261753	15458X11	1	5	6	sperm	NC_000001.11	0.43	15458X11	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	NaN	15458X11_NC_000001.11_sperm
16534	15458X10	1	2	3	blood	NC_000001.11	0.43	15458X10	0.5	0	0.3333333333333333	-0.166667	NaN	15458X10_NC_000001.11_blood
182686	15458X10	3	2	5	blood	NC_000001.11	0.43	15458X10	0.3333333333333333	0	0.6	0.266667	NaN	15458X10_NC_000001.11_blood
186810	15458X10	2	2	4	blood	NC_000001.11	0.43	15458X10	0.5333333333333333	0.1333333333333333	0.5	-0.033333	NaN	15458X10_NC_000001.11_blood
186835	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.5416666666666666	0.20833333333333334	0.25	-0.291667	NaN	15458X10_NC_000001.11_blood
261454	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.4777777777777778	0.10999438818457406	0.25	-0.227778	NaN	15458X10_NC_000001.11_blood
261463	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X10_NC_000001.11_blood
261478	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X10_NC_000001.11_blood
261495	15458X10	1	4	5	blood	NC_000001.11	0.43	15458X10	0.45208333333333334	0.10514127400787951	0.2	-0.252083	NaN	15458X10_NC_000001.11_blood
261753	15458X10	1	5	6	blood	NC_000001.11	0.43	15458X10	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	NaN	15458X10_NC_000001.11_blood
16534	15458X10	1	2	3	sperm	NC_000001.11	0.43	15458X10	0.5	0	0.3333333333333333	-0.166667	NaN	15458X10_NC_000001.11_sperm
182686	15458X10	3	2	5	sperm	NC_000001.11	0.43	15458X10	0.3333333333333333	0	0.6	0.266667	NaN	15458X10_NC_000001.11_sperm
186810	15458X10	2	2	4	sperm	NC_000001.11	0.43	15458X10	0.5333333333333333	0.1333333333333333	0.5	-0.033333	NaN	15458X10_NC_000001.11_sperm
186835	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.5416666666666666	0.20833333333333334	0.25	-0.291667	NaN	15458X10_NC_000001.11_sperm
261454	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.4777777777777778	0.10999438818457406	0.25	-0.227778	NaN	15458X10_NC_000001.11_sperm
261463	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X10_NC_000001.11_sperm
261478	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	NaN	15458X10_NC_000001.11_sperm
261495	15458X10	1	4	5	sperm	NC_000001.11	0.43	15458X10	0.45208333333333334	0.10514127400787951	0.2	-0.252083	NaN	15458X10_NC_000001.11_sperm
261753	15458X10	1	5	6	sperm	NC_000001.11	0.43	15458X10	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	NaN	15458X10_NC_000001.11_sperm
`

const ftinNoNaN = `pos	indiv	hits	althits	count	tissue	chrom	gc	sample	bloodmean	bloodsd	value	sub	norm	indiv_chrom_tissue
16534	15458X11	1	2	3	blood	NC_000001.11	0.43	15458X11	0.5	0	0.3333333333333333	-0.166667	0.5	15458X11_NC_000001.11_blood
182686	15458X11	3	2	5	blood	NC_000001.11	0.43	15458X11	0.3333333333333333	0	0.6	0.266667	0.5	15458X11_NC_000001.11_blood
186810	15458X11	2	2	4	blood	NC_000001.11	0.43	15458X11	0.5333333333333333	0.1333333333333333	0.5	-0.033333	0.5	15458X11_NC_000001.11_blood
186835	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.5416666666666666	0.20833333333333334	0.25	-0.291667	0.5	15458X11_NC_000001.11_blood
261454	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.4777777777777778	0.10999438818457406	0.25	-0.227778	0.5	15458X11_NC_000001.11_blood
261463	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X11_NC_000001.11_blood
261478	15458X11	1	3	4	blood	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X11_NC_000001.11_blood
261495	15458X11	1	4	5	blood	NC_000001.11	0.43	15458X11	0.45208333333333334	0.10514127400787951	0.2	-0.252083	0.5	15458X11_NC_000001.11_blood
261753	15458X11	1	5	6	blood	NC_000001.11	0.43	15458X11	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	0.5	15458X11_NC_000001.11_blood
16534	15458X11	1	2	3	sperm	NC_000001.11	0.43	15458X11	0.5	0	0.3333333333333333	-0.166667	0.5	15458X11_NC_000001.11_sperm
182686	15458X11	3	2	5	sperm	NC_000001.11	0.43	15458X11	0.3333333333333333	0	0.6	0.266667	0.5	15458X11_NC_000001.11_sperm
186810	15458X11	2	2	4	sperm	NC_000001.11	0.43	15458X11	0.5333333333333333	0.1333333333333333	0.5	-0.033333	0.5	15458X11_NC_000001.11_sperm
186835	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.5416666666666666	0.20833333333333334	0.25	-0.291667	0.5	15458X11_NC_000001.11_sperm
261454	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.4777777777777778	0.10999438818457406	0.25	-0.227778	0.5	15458X11_NC_000001.11_sperm
261463	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X11_NC_000001.11_sperm
261478	15458X11	1	3	4	sperm	NC_000001.11	0.43	15458X11	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X11_NC_000001.11_sperm
261495	15458X11	1	4	5	sperm	NC_000001.11	0.43	15458X11	0.45208333333333334	0.10514127400787951	0.2	-0.252083	0.5	15458X11_NC_000001.11_sperm
261753	15458X11	1	5	6	sperm	NC_000001.11	0.43	15458X11	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	0.5	15458X11_NC_000001.11_sperm
16534	15458X10	1	2	3	blood	NC_000001.11	0.43	15458X10	0.5	0	0.3333333333333333	-0.166667	0.5	15458X10_NC_000001.11_blood
182686	15458X10	3	2	5	blood	NC_000001.11	0.43	15458X10	0.3333333333333333	0	0.6	0.266667	0.5	15458X10_NC_000001.11_blood
186810	15458X10	2	2	4	blood	NC_000001.11	0.43	15458X10	0.5333333333333333	0.1333333333333333	0.5	-0.033333	0.5	15458X10_NC_000001.11_blood
186835	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.5416666666666666	0.20833333333333334	0.25	-0.291667	0.5	15458X10_NC_000001.11_blood
261454	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.4777777777777778	0.10999438818457406	0.25	-0.227778	0.5	15458X10_NC_000001.11_blood
261463	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X10_NC_000001.11_blood
261478	15458X10	1	3	4	blood	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X10_NC_000001.11_blood
261495	15458X10	1	4	5	blood	NC_000001.11	0.43	15458X10	0.45208333333333334	0.10514127400787951	0.2	-0.252083	0.5	15458X10_NC_000001.11_blood
261753	15458X10	1	5	6	blood	NC_000001.11	0.43	15458X10	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	0.5	15458X10_NC_000001.11_blood
16534	15458X10	1	2	3	sperm	NC_000001.11	0.43	15458X10	0.5	0	0.3333333333333333	-0.166667	0.5	15458X10_NC_000001.11_sperm
182686	15458X10	3	2	5	sperm	NC_000001.11	0.43	15458X10	0.3333333333333333	0	0.6	0.266667	0.5	15458X10_NC_000001.11_sperm
186810	15458X10	2	2	4	sperm	NC_000001.11	0.43	15458X10	0.5333333333333333	0.1333333333333333	0.5	-0.033333	0.5	15458X10_NC_000001.11_sperm
186835	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.5416666666666666	0.20833333333333334	0.25	-0.291667	0.5	15458X10_NC_000001.11_sperm
261454	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.4777777777777778	0.10999438818457406	0.25	-0.227778	0.5	15458X10_NC_000001.11_sperm
261463	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X10_NC_000001.11_sperm
261478	15458X10	1	3	4	sperm	NC_000001.11	0.43	15458X10	0.4539682539682539	0.1103374425205255	0.25	-0.203968	0.5	15458X10_NC_000001.11_sperm
261495	15458X10	1	4	5	sperm	NC_000001.11	0.43	15458X10	0.45208333333333334	0.10514127400787951	0.2	-0.252083	0.5	15458X10_NC_000001.11_sperm
261753	15458X10	1	5	6	sperm	NC_000001.11	0.43	15458X10	0.4516473255969054	0.18157821736566115	0.16666666666666666	-0.284981	0.5	15458X10_NC_000001.11_sperm
`

func TestRunFTest(t *testing.T) {
	h := handle("Run: %w")

	cr := csv.NewReader(strings.NewReader(ftin))
	cr.Comma = rune('\t')

	valcol := 13
	idcolsnames := []string{"tissue", "indiv_chrom_tissue"}
	idcols := []int{5, 14}
	controlsetidx := 0
	testsetidx := 1

	tsummaries, testsets, e := CalcTSummaryFromCsvReader(cr, valcol, idcolsnames, idcols, controlsetidx, testsetidx)
	if e != nil { panic(h(e)) }

	var b strings.Builder

	fmt.Println(tsummaries)
	fmt.Println(*tsummaries[0])
	fmt.Println(*tsummaries[1])
	fmt.Println(testsets)
	e = FTests(&b, tsummaries, testsets)
	if e != nil { panic(h(e)) }

	out := b.String()
	fmt.Println("output:")
	fmt.Println(out)
}

func TestRunFTestNoNaN(t *testing.T) {
	h := handle("Run: %w")

	cr := csv.NewReader(strings.NewReader(ftinNoNaN))
	cr.Comma = rune('\t')

	valcol := 13
	idcolsnames := []string{"tissue", "indiv_chrom_tissue"}
	idcols := []int{5, 14}
	controlsetidx := 0
	testsetidx := 1

	tsummaries, testsets, e := CalcTSummaryFromCsvReader(cr, valcol, idcolsnames, idcols, controlsetidx, testsetidx)
	if e != nil { panic(h(e)) }

	var b strings.Builder

	fmt.Println(tsummaries)
	fmt.Println(*tsummaries[0])
	fmt.Println(*tsummaries[1])
	fmt.Println(testsets)
	e = FTests(&b, tsummaries, testsets)
	if e != nil { panic(h(e)) }

	out := b.String()
	fmt.Println("output:")
	fmt.Println(out)
}
